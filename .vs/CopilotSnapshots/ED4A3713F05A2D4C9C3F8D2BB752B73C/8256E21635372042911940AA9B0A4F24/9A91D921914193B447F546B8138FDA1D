// OnlineCourse/Data/PermissionSeeder.cs
using OnlineCourse.Models.Entities;
using Microsoft.EntityFrameworkCore;


namespace OnlineCourse.Data
{
    public static class PermissionSeeder
    {
        public static async Task SeedAsync(AppDbContext context)
        {
            if (!await context.Permissions.AnyAsync())
            {
                var permissions = new List<Permission>
                {
                    new Permission { PermissionName = "User.View" },
                    new Permission { PermissionName = "User.Manage" },
                    new Permission { PermissionName = "Role.View" },
                    new Permission { PermissionName = "Role.Create" },
                    new Permission { PermissionName = "Role.Edit" },
                    new Permission { PermissionName = "Role.Delete" },
                    new Permission { PermissionName = "Course.View" },
                    new Permission { PermissionName = "Course.Create" },
                    new Permission { PermissionName = "Course.Edit" },
                    new Permission { PermissionName = "Course.Delete" },
                    new Permission { PermissionName = "Lesson.View" },
                    new Permission { PermissionName = "Lesson.Create" },
                    new Permission { PermissionName = "Lesson.Edit" },
                    new Permission { PermissionName = "Lesson.Delete" },
                    new Permission { PermissionName = "Payment.View" },
                    new Permission { PermissionName = "Payment.Refund" },
                    new Permission { PermissionName = "Log.View" }
                };
                await context.Permissions.AddRangeAsync(permissions);
                await context.SaveChangesAsync();
            }

            // Gán quyền cho vai trò "Admin" (tất cả quyền)
            await AssignPermissionsToRoleAsync(context, "Admin", 
                await context.Permissions.Select(p => p.PermissionName).ToListAsync());

            // Gán quyền cho vai trò "Instructor"
            await AssignPermissionsToRoleAsync(context, "Instructor", new List<string>
            {
                "Course.View", 
                "Course.Create", 
                "Course.Edit", 
                "Course.Delete",
                "Lesson.View", 
                "Lesson.Create", 
                "Lesson.Edit", 
                "Lesson.Delete"
            });

            // Gán quyền cho vai trò "Student"
            await AssignPermissionsToRoleAsync(context, "Student", new List<string>
            {
                "Course.View", 
                "Lesson.View", 
                "Payment.View"
            });
        }

        private static async Task AssignPermissionsToRoleAsync(AppDbContext context, string roleName, List<string> permissionNames)
        {
            var role = await context.Roles.FirstOrDefaultAsync(r => r.RoleName == roleName);
            if (role == null)
            {
                role = new Role { RoleName = roleName };
                await context.Roles.AddAsync(role);
                await context.SaveChangesAsync();
            }

            foreach (var permName in permissionNames)
            {
                var permission = await context.Permissions
                    .FirstOrDefaultAsync(p => p.PermissionName == permName);
                
                if (permission != null && 
                    !await context.RolePermissions.AnyAsync(rp => 
                        rp.RoleId == role.RoleId && rp.PermissionId == permission.PermissionId))
                {
                    await context.RolePermissions.AddAsync(new RolePermission 
                    { 
                        RoleId = role.RoleId, 
                        PermissionId = permission.PermissionId 
                    });
                }
            }
            await context.SaveChangesAsync();
        }
    }
}}